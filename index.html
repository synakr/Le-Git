<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Le-Git</title>
    <link rel="stylesheet" href="styles/style.css">
  </head>
  <body class="dark-mode">

    <!-- STEP 2: Add a sidebar wrapper -->
    <div id="sidebar">
      <button id="dark-mode-toggle" class="theme-toggle">
        <div class="sun-moon">
          <div class="sun-rays"></div>
          <div class="moon"></div>
        </div>
      </button>


      <form id="create-node-form">
        <input type="text" id="node-name" placeholder="Node Name" required>
        <select id="node-type">
          <option value="playlist">Playlist</option>
          <option value="custom">Custom Group</option>
        </select>
        <input type="text" id="playlist-url" placeholder="Playlist URL" style="display:none;">
        <button type="submit">Create Node</button>
      </form>

      <div id="capture-video">
        <button id="capture-btn">Capture Current Video</button>
      </div>
      <div id="capture-form" style="display:none; gap:5px; margin-top:5px;">
        <input type="text" id="capture-url" placeholder="YouTube URL">
        <input type="text" id="capture-ts" placeholder="Timestamp mm:ss">
        <button id="capture-save-btn">Save</button>
      </div>

      <div id="quick-mark">
        <input type="number" id="mark-up-to" placeholder="Mark up to video #" min="1">
        <button id="mark-btn">Mark Videos</button>
      </div>
    </div>
    <!-- END sidebar -->

    <!-- STEP 3: Wrap main content in #main -->
    <div id="main">
      <h1>Welcome to Le-Git</h1>
      <h2>Your lecture tracker starts here!</h2>

      <div id="video-player" style="margin-top:20px;"></div>
      <div id="nodes-container"></div>
    </div>













    <script>
      const { ipcRenderer } = require('electron');



      // Toggle playlist URL input
      const nodeTypeSelect = document.getElementById('node-type');
      const playlistUrlInput = document.getElementById('playlist-url');
      nodeTypeSelect.addEventListener('change', () => {
        playlistUrlInput.style.display = nodeTypeSelect.value === 'playlist' ? 'block' : 'none';
        if (nodeTypeSelect.value !== 'playlist') playlistUrlInput.value = '';
      });

      // Dark mode
      const toggle = document.getElementById('dark-mode-toggle');
      toggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
      });

      // Create node
      const form = document.getElementById('create-node-form');
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        ipcRenderer.send('create-node', {
          name: document.getElementById('node-name').value,
          type: document.getElementById('node-type').value,
          playlistUrl: playlistUrlInput.value.trim()
        });
        form.reset();
      });

      // Quick mark
      document.getElementById('mark-btn').addEventListener('click', () => {
        const upTo = parseInt(document.getElementById('mark-up-to').value);
        if (upTo > 0) ipcRenderer.send('mark-up-to', { upTo });
      });

      // Capture video UI
      const captureForm = document.getElementById('capture-form');
      const captureUrl = document.getElementById('capture-url');
      const captureTs = document.getElementById('capture-ts');
      document.getElementById('capture-btn').addEventListener('click', () => {
        captureForm.style.display = captureForm.style.display === 'none' ? 'flex' : 'none';
      });
      document.getElementById('capture-save-btn').addEventListener('click', () => {
        const url = captureUrl.value.trim();
        const ts = captureTs.value.trim() || '00:00';
        if (url) ipcRenderer.send('capture-video-ui', { url, ts });
        captureUrl.value = '';
        captureTs.value = '';
        captureForm.style.display = 'none';
      });

      // Render nodes
      ipcRenderer.on('load-nodes', (event, nodes) => {
        const container = document.getElementById('nodes-container');
        container.innerHTML = '';

        nodes.forEach(node => {
          const div = document.createElement('div');
          div.classList.add('node');

          // Node header
          const headerHtml = `
            <div class="node-header">
              <span class="node-title">${node.name}</span>
              <span class="node-type">[${node.type}]</span>
              <span class="node-progress">Progress: ${node.progress || 0}%</span>
            </div>
            <div class="node-controls">
              <input type="checkbox" class="node-complete" data-id="${node.id}" ${node.progress === 100 ? 'checked' : ''}>
              <button class="continue-btn" data-id="${node.id}">Continue</button>
              <button class="delete-btn" data-id="${node.id}">Delete</button>
              <button class="up-btn" data-id="${node.id}">↑</button>
              <button class="down-btn" data-id="${node.id}">↓</button>
              <button class="toggle-content-btn" data-id="${node.id}">▼</button>
            </div>
            <textarea class="node-notes" data-id="${node.id}" placeholder="Add notes...">${node.notes || ''}</textarea>
            <div class="node-content" style="display:none;"></div>
          `;
          div.innerHTML = headerHtml;
          container.appendChild(div);

          const contentDiv = div.querySelector('.node-content');
          const toggleBtn = div.querySelector('.toggle-content-btn');

          // Toggle dropdown content
          toggleBtn.addEventListener('click', () => {
            if (contentDiv.style.display === 'none') {
              contentDiv.style.display = 'block';
              toggleBtn.textContent = '▲';
            } else {
              contentDiv.style.display = 'none';
              toggleBtn.textContent = '▼';
            }
          });

          // Custom node content
          if (node.type === 'custom') {
            const customHtml = `
              <div class="custom-area" data-id="${node.id}">
                <div class="add-video-row">
                  <input class="add-video-url" type="text" placeholder="Add video URL">
                  <input class="add-video-ts" type="text" placeholder="Timestamp mm:ss">
                  <button class="add-video-btn" data-id="${node.id}">Add</button>
                  <button class="mark-all-btn" data-id="${node.id}">Mark All Watched</button>
                </div>
                <ul class="video-list"></ul>
              </div>
            `;
            contentDiv.innerHTML = customHtml;

            const customArea = contentDiv.querySelector('.custom-area');
            const addBtn = customArea.querySelector('.add-video-btn');
            const urlInput = customArea.querySelector('.add-video-url');
            const tsInput = customArea.querySelector('.add-video-ts');
            const markAllBtn = customArea.querySelector('.mark-all-btn');
            const videoList = customArea.querySelector('.video-list');

            addBtn.addEventListener('click', () => {
              const url = urlInput.value.trim();
              const ts = tsInput.value.trim() || '00:00';
              if (!url) return;
              ipcRenderer.send('add-video-to-node', { id: node.id, url, ts });
              urlInput.value = '';
              tsInput.value = '';
            });

            markAllBtn.addEventListener('click', () => ipcRenderer.send('mark-all-videos', { id: node.id, watched: 1 }));

            ipcRenderer.invoke('get-videos', node.id).then(videos => {
              videoList.innerHTML = '';
              videos.forEach(v => {
                const li = document.createElement('li');
                li.classList.add('video-item');
                li.innerHTML = `
                  <input type="checkbox" class="video-watched" data-id="${v.id}" ${v.watched ? 'checked' : ''}>
                  <span class="video-url">${v.url}</span>
                  <span class="video-ts">(${v.timestamp})</span>
                  <button class="continue-video-btn" data-url="${v.url}" data-ts="${v.timestamp}">Continue</button>
                  <button class="del-video-btn" data-id="${v.id}">Delete</button>
                `;
                videoList.appendChild(li);

                li.querySelector('.video-watched').addEventListener('change', ev =>
                  ipcRenderer.send('toggle-video-watched', { videoId: ev.target.dataset.id, watched: ev.target.checked ? 1 : 0, nodeId: node.id })
                );
                li.querySelector('.continue-video-btn').addEventListener('click', ev =>
                  ipcRenderer.send('continue-video', { url: ev.target.dataset.url, ts: ev.target.dataset.ts })
                );
                li.querySelector('.del-video-btn').addEventListener('click', ev => {
                  if(confirm('Delete this video?')) ipcRenderer.send('delete-custom-video', { videoId: ev.target.dataset.id, nodeId: node.id });
                });
              });
            }).catch(console.error);
          }

          // Playlist node content
          if (node.type === 'playlist') {
            contentDiv.innerHTML = `<div class="playlist-area" data-id="${node.id}"><ul class="playlist-videos"></ul></div>`;
            const playlistArea = contentDiv.querySelector('.playlist-area');
            const ul = playlistArea.querySelector('.playlist-videos');
            ipcRenderer.invoke('get-playlist-videos', node.id).then(videos => {
              ul.innerHTML = '';
              videos.forEach(v => {
                const li = document.createElement('li');
                li.classList.add('playlist-video');
                li.innerHTML = `
                  <input type="checkbox" class="video-watched" data-id="${v.id}" ${v.watched ? 'checked' : ''}>
                  <span>${v.title}</span>
                  <button class="continue-playlist-btn" data-vid="${v.video_id}">Continue</button>
                `;
                ul.appendChild(li);

                li.querySelector('.video-watched').addEventListener('change', ev =>
                  ipcRenderer.send('toggle-playlist-watched', { videoId: ev.target.dataset.id, nodeId: node.id, watched: ev.target.checked ? 1 : 0 })
                );
                li.querySelector('.continue-playlist-btn').addEventListener('click', ev =>
                  ipcRenderer.send('continue-playlist-video', { videoId: ev.target.dataset.vid })
                );
              });
            });
          }

          // Node controls
          const completeCheckbox = div.querySelector('.node-complete');
          completeCheckbox.addEventListener('change', e => {
            const isChecked = e.target.checked;
            if (node.type === 'custom') ipcRenderer.send('mark-all-videos', { id: node.id, watched: isChecked ? 1 : 0 });
            else ipcRenderer.send('update-progress', { id: node.id, progress: isChecked ? 100 : 0 });
          });
          div.querySelector('.continue-btn').addEventListener('click', e => ipcRenderer.send('continue-node', { id: node.id }));
          div.querySelector('.delete-btn').addEventListener('click', e => { if(confirm('Delete this node and all its videos?')) ipcRenderer.send('delete-node', { id: node.id }); });
          div.querySelector('.up-btn').addEventListener('click', e => ipcRenderer.send('move-node', { id: node.id, direction: 'up' }));
          div.querySelector('.down-btn').addEventListener('click', e => ipcRenderer.send('move-node', { id: node.id, direction: 'down' }));
          div.querySelector('.node-notes').addEventListener('blur', e => ipcRenderer.send('save-notes', { id: node.id, notes: e.target.value }));
        });
      });



      ipcRenderer.on('play-video', (event, data) => {
        document.getElementById('video-player').innerHTML = `
          <div class="video-wrapper">
            <button class="close-video">×</button>
            <iframe width="640" height="360"
              src="https://www.youtube.com/embed/${data.videoId}?autoplay=1"
              frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
          </div>
        `;

        // Close button logic
        document.querySelector('.close-video').addEventListener('click', () => {
          document.getElementById('video-player').innerHTML = '';
        });

      });
      
      // Make video-player draggable
      function makeDraggable(el) {
        let pos = { x: 0, y: 0, offsetX: 0, offsetY: 0 };

        el.querySelector('.video-wrapper').addEventListener('mousedown', (e) => {
          pos.offsetX = e.clientX - el.offsetLeft;
          pos.offsetY = e.clientY - el.offsetTop;

          function onMouseMove(ev) {
            pos.x = ev.clientX - pos.offsetX;
            pos.y = ev.clientY - pos.offsetY;

            // keep inside window bounds
            pos.x = Math.max(0, Math.min(window.innerWidth - el.offsetWidth, pos.x));
            pos.y = Math.max(0, Math.min(window.innerHeight - el.offsetHeight, pos.y));

            el.style.left = pos.x + 'px';
            el.style.top = pos.y + 'px';
            el.style.bottom = 'auto'; // disable bottom/right anchor when dragging
            el.style.right = 'auto';
          }

          function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
          }

          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        });
      }

      ipcRenderer.on('play-video', (event, data) => {
        const vp = document.getElementById('video-player');
        vp.innerHTML = `
          <div class="video-wrapper">
            <div id="drag-handle">⇕</div>
            <button class="close-video">×</button>
            <iframe width="100%" height="100%"
            src="https://www.youtube.com/embed/${data.videoId}?autoplay=1"
            frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
          </div>
        `;

        // Reset anchors for fixed positioning
        vp.style.left = 'auto';
        vp.style.top = 'auto';
        vp.style.right = '20px';
        vp.style.bottom = '20px';

        // Close button
        document.querySelector('.close-video').addEventListener('click', () => {
          vp.innerHTML = '';
        });

        // Make draggable
        makeDraggable(vp);
      });


    </script>
  </body>
</html>
