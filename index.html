<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Le-Git</title>
    <link rel="stylesheet" href="styles/style.css">
  </head>
  <body class="dark-mode">

    <!-- STEP 2: Add a sidebar wrapper -->
    <div id="sidebar">
      <button id="dark-mode-toggle" class="theme-toggle">
        <div class="sun-moon">
          <div class="sun-rays"></div>
          <div class="moon"></div>
        </div>
      </button>


      <form id="create-node-form">
        <input type="text" id="node-name" placeholder="Node Name" required>
        <!-- <input type="text" id="playlist-url" placeholder="Playlist URL" style="display:none;"> -->
        <input type="text" id="playlist-url" placeholder="Playlist URL">
        <select id="node-type">
          <option value="playlist">Playlist</option>
          <option value="custom">Custom Group</option>
        </select>
        <button type="submit">Create Node</button>
      </form>


      
      <!-- Streak Graph -->
      <div id="streak-graph-container" style="margin:18px 0 0 0;">
        <div style="font-size:15px;font-weight:500;margin-bottom:6px;color:#38bdf8;">Streak (Last 30 Days)</div>
        <div id="streak-graph" style="display:flex;gap:2px;"></div>
        <div id="streak-graph-label" style="font-size:13px;color:#555;margin-top:6px;"></div>
      </div>
      <!-- Random Quote Box -->
      <div id="random-quote-box" style="margin:22px 0 0 0;padding:18px 22px;background:#23272f;border-radius:12px;box-shadow:0 2px 12px rgba(60,80,120,0.10);display:flex;flex-direction:column;align-items:flex-start;gap:8px;min-height:80px;max-width:340px;">
        <p class="quote" style="font-size:16px;font-style:italic;color:#38bdf8;margin:0 0 4px 0;">"Glory shines over the most caffeinated"</p>
        <p class="author" style="font-size:14px;color:#4ade80;font-weight:500;margin:0;align-self:flex-end;">- Md Sayan Akram</p>
      </div>
    </div>

    <!-- END sidebar -->

    <!-- STEP 3: Wrap main content in #main -->
    <div id="main">
      <h1>Welcome to Le-Git</h1>
      <h2>Your lecture tracker starts here!</h2>

      <div id="video-player" style="margin-top:20px;"></div>
      <div id="nodes-container"></div>
    </div>

    <!-- Info Icon -->
    <div id="info-icon" style="position:fixed;top:18px;right:24px;z-index:9999;cursor:pointer;">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#38bdf8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="background:#fff ;border-radius:50%;box-shadow:0 2px 8px rgba(60,80,120,0.10);padding:4px;">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="16" x2="12" y2="12"/>
        <line x1="12" y1="8" x2="12" y2="8"/>
      </svg>
    </div>
    <div id="info-popover" style="display:none;position:fixed;top:54px;right:32px;z-index:10000;background:#fff;color:#222;border-radius:12px;box-shadow:0 8px 32px rgba(60,80,120,0.18);padding:22px 28px;min-width:320px;max-width:380px;font-size:15px;line-height:1.6;">
      <div style="font-size:18px;font-weight:600;margin-bottom:8px;color:#38bdf8;">Le-Git App Info</div>
      <div><b>Version:</b> 1.0.0</div>
      <div><b>Creator:</b> <a href="https://github.com/synakr" target="_blank" style="color:#4ade80;text-decoration:none;">synakr</a>, <a href="https://github.com/Haunter05" target="_blank" style="color:#4ade80;text-decoration:none;">Haunter05</a></div>
      <div><b>License:</b> <a href="https://opensource.org/licenses/MIT" target="_blank" style="color:#4ade80;text-decoration:none;">MIT</a></div>
      <div><b>Source:</b> <a href="https://github.com/your-username/le-git" target="_blank" style="color:#4ade80;text-decoration:none;">GitHub Repo</a></div>
      <div><b>Tech Stack:</b> Electron.js, SQLite, HTML/CSS/JS</div>
      <div style="margin-top:10px;font-size:13px;color:#555;">Made for NIT students and beyond. <br>Track your lectures, playlists, and custom groups <b>offline</b>.<br>Contact: <a href="mailto:your@email.com" style="color:#38bdf8;text-decoration:none;">hrjbgm@email.com</a></div>
      <button id="close-info-popover" style="margin-top:14px;background:#38bdf8;color:#fff;border:none;border-radius:6px;padding:6px 18px;font-size:15px;cursor:pointer;">Close</button>
    </div>

    <!-- AI Chatbot Icon and Chat Window -->
    <div id="ai-chatbot-icon" class="ai-theme-icon" style="transition:transform 0.6s ease-in-out;">
      <svg id="ai-chatbot-svg" width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" style="transition:transform 0.6s ease-in-out;">
        <g>
          <path d="M16 4 L18 14 L28 16 L18 18 L16 28 L14 18 L4 16 L14 14 Z" fill="#22c55e" stroke="#4ade80" stroke-width="1.5"/>
          <circle cx="16" cy="16" r="3.5" fill="#4ade80" opacity="0.7"/>
        </g>
      </svg>
    </div>
  <div id="ai-chatbot-window" class="ai-theme-window" style="display:none;flex-direction:column;position:fixed;z-index:10001;min-width:400px;max-width:520px;right:32px;top:60px;background:#18181b;border-radius:16px;box-shadow:0 8px 32px rgba(60,80,120,0.18);border:2px solid #22c55e;overflow:hidden;height:540px;max-height:80vh;">
      <div class="ai-theme-header" style="background:#22c55e;color:#fff;padding:8px 16px 8px 16px;font-size:16px;font-weight:600;display:flex;align-items:center;justify-content:space-between;min-height:38px;flex-shrink:0;position:relative;">
        <span style="display:flex;align-items:center;gap:6px;font-size:15px;"><svg width="18" height="18" viewBox="0 0 32 32" fill="none"><g><path d="M16 4 L18 14 L28 16 L18 18 L16 28 L14 18 L4 16 L14 14 Z" fill="#fff" stroke="#4ade80" stroke-width="1.2"/><circle cx="16" cy="16" r="3.5" fill="#4ade80" opacity="0.7"/></g></svg>AI Chatbot</span>
        <div style="display:flex;align-items:center;gap:8px;">
          <button id="ai-chatbot-newchat" style="background:#23272f;color:#22c55e;border:none;border-radius:6px;padding:4px 12px;font-size:13px;font-weight:500;cursor:pointer;transition:background 0.2s, color 0.2s;">New Chat</button>
          <button id="ai-chatbot-close" class="ai-theme-close" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;line-height:1;">&times;</button>
        </div>
        <div id="ai-chatbot-border-anim" style="display:none;position:absolute;top:-2px;left:-2px;width:calc(100% + 4px);height:calc(100% + 4px);pointer-events:none;z-index:10;"></div>
      </div>
      <div style="position:relative;flex:1;display:flex;flex-direction:column;min-height:0;">
        <div id="ai-chatbot-messages" class="ai-theme-messages" style="flex:1;overflow-y:auto;padding:10px 16px 10px 16px;background:#18181b;min-height:0;"></div>
        <div id="ai-chatbot-starter" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#22c55e;font-size:17px;font-weight:500;opacity:0.85;text-align:center;pointer-events:none;">Hi user, ask your query</div>
      </div>
      <form id="ai-chatbot-form" class="ai-theme-form" style="display:flex;gap:6px;padding:8px 16px 10px 16px;background:#18181b;border-top:1px solid #22c55e;min-height:38px;flex-shrink:0;">
        <input id="ai-chatbot-input" type="text" placeholder="Ask me anything..." autocomplete="off" style="flex:1;padding:7px 10px;border-radius:6px;border:1.2px solid #22c55e;background:#23272f;color:#fff;font-size:14px;outline:none;transition:border 0.2s;min-height:32px;" />
        <button type="submit" style="background:#22c55e;color:#fff;border:none;border-radius:6px;padding:0 14px;font-size:14px;font-weight:500;cursor:pointer;transition:background 0.2s;min-height:32px;">Send</button>
      </form>
      <style>
        .ai-msg.user .bubble {
          background:#22c55e;
          color:#fff;
          border-radius:10px 10px 4px 10px;
          padding:7px 12px;
          margin-bottom:5px;
          max-width:75%;
          font-size:14px;
          box-shadow:0 2px 8px rgba(60,80,120,0.08);
          align-self:flex-end;
          transition:background 0.2s;
        }
        .ai-msg.user .bubble:hover {
          background:#4ade80;
        }
        .ai-msg.bot .bubble {
          background:#23272f;
          color:#22c55e;
          border-radius:10px 10px 10px 4px;
          padding:7px 12px;
          margin-bottom:5px;
          max-width:75%;
          font-size:14px;
          box-shadow:0 2px 8px rgba(60,80,120,0.08);
          align-self:flex-start;
          transition:color 0.2s;
        }
        .ai-msg.bot .bubble:hover {
          color:#4ade80;
        }
        .ai-theme-messages {
          display:flex;
          flex-direction:column;
          gap:1px;
        }
        #ai-chatbot-window::-webkit-scrollbar, .ai-theme-messages::-webkit-scrollbar {
          width:8px;
          background:#23272f;
        }
        #ai-chatbot-window::-webkit-scrollbar-thumb, .ai-theme-messages::-webkit-scrollbar-thumb {
          background:#22c55e;
          border-radius:8px;
        }
        #ai-chatbot-input:focus {
          border-color:#4ade80;
        }
        #ai-chatbot-newchat:hover {
          background:#22c55e;
          color:#fff;
        }
        @media (max-width: 600px) {
          #ai-chatbot-window { min-width:95vw; max-width:99vw; right:2vw; top:6vw; }
        }
        /* Border animation */
        @keyframes border-run {
          0% { box-shadow: 0 0 0 2px #22c55e, 0 0 0 0 #4ade80; }
          25% { box-shadow: 0 0 0 2px #22c55e, 0 0 8px 4px #4ade80; }
          50% { box-shadow: 0 0 0 2px #22c55e, 0 0 16px 8px #4ade80; }
          75% { box-shadow: 0 0 0 2px #22c55e, 0 0 8px 4px #4ade80; }
          100% { box-shadow: 0 0 0 2px #22c55e, 0 0 0 0 #4ade80; }
        }
        #ai-chatbot-border-anim.active {
          animation: border-run 1.2s cubic-bezier(.68,-0.55,.27,1.55);
          border-radius:16px;
        }
        /* Icon hover animation removed - static icon */
      </style>
    </div>







<!-- this script is for random quotes -->
<script>
const url = 'https://prem-k-r.github.io/multilingual-quotes-api/minified/en.json';
let quote = document.querySelector('.quote');
let author = document.querySelector('.author');

const myQuotes = [
        { quote: "Glory shines over the most caffeinated", author: "Md Sayan Akram" }
    ];

    fetch(url)
        .then(res => res.json())
        .then(data => {
            const allQuotes = data.concat(myQuotes); // merge JSON + your quotes
            let random = allQuotes[Math.floor(Math.random() * allQuotes.length)];
            quote.textContent = `"${random.quote}"`;
            author.textContent = `- ${random.author}`;
            console.log(allQuotes);
        })
        .catch(err => console.error(err));
</script>




    <script>
      const { ipcRenderer } = require('electron');

      // --- AI Chatbot Draggable Icon & Chat Window ---
      const aiIcon = document.getElementById('ai-chatbot-icon');
      const aiWindow = document.getElementById('ai-chatbot-window');
      const aiClose = document.getElementById('ai-chatbot-close');
      const aiForm = document.getElementById('ai-chatbot-form');
      const aiInput = document.getElementById('ai-chatbot-input');
      const aiMessages = document.getElementById('ai-chatbot-messages');
      let dragOffsetX = 0, dragOffsetY = 0, dragging = false;

      // Drag logic
      aiIcon.addEventListener('mousedown', (e) => {
        dragging = true;
        dragOffsetX = e.clientX - aiIcon.getBoundingClientRect().left;
        dragOffsetY = e.clientY - aiIcon.getBoundingClientRect().top;
        aiIcon.style.transition = 'none';
        document.body.style.userSelect = 'none';
      });
      document.addEventListener('mousemove', (e) => {
        if (!dragging) return;
        let x = e.clientX - dragOffsetX;
        let y = e.clientY - dragOffsetY;
        // Clamp to window
        x = Math.max(0, Math.min(window.innerWidth - aiIcon.offsetWidth, x));
        y = Math.max(0, Math.min(window.innerHeight - aiIcon.offsetHeight, y));
        aiIcon.style.left = x + 'px';
        aiIcon.style.top = y + 'px';
        aiIcon.style.right = 'auto';
        aiIcon.style.bottom = 'auto';
        // Move chat window with icon
        aiWindow.style.right = 'auto';
        aiWindow.style.bottom = 'auto';
        aiWindow.style.left = x + 'px';
        aiWindow.style.top = (y - aiWindow.offsetHeight - 16) + 'px';
      });
      document.addEventListener('mouseup', () => {
        if (dragging) {
          dragging = false;
          aiIcon.style.transition = '';
          document.body.style.userSelect = '';
        }
      });

      // Toggle chat window
      aiIcon.addEventListener('click', (e) => {
        if (dragging) return; // Don't open on drag
        aiWindow.style.display = aiWindow.style.display === 'none' ? 'flex' : 'none';
        // Position chat window above icon
        const rect = aiIcon.getBoundingClientRect();
        aiWindow.style.left = rect.left + 'px';
        aiWindow.style.top = (rect.top - aiWindow.offsetHeight - 16) + 'px';
        aiWindow.style.right = 'auto';
        aiWindow.style.bottom = 'auto';
      });
      aiClose.addEventListener('click', () => {
        aiWindow.style.display = 'none';
      });

      // Chat logic
      function appendMsg(text, sender) {
        const msg = document.createElement('div');
        msg.className = 'ai-msg ' + sender;
        msg.innerHTML = `<div class="bubble">${text}</div>`;
        aiMessages.appendChild(msg);
        aiMessages.scrollTop = aiMessages.scrollHeight;
        // Hide starter message on first message
        const starter = document.getElementById('ai-chatbot-starter');
        if (starter) starter.style.display = 'none';
      }

      function showStarterMsg() {
        const starter = document.getElementById('ai-chatbot-starter');
        if (starter) starter.style.display = 'block';
      }

      aiForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const q = aiInput.value.trim();
        if (!q) return;
        appendMsg(q, 'user');
        aiInput.value = '';
        appendMsg('<span style="color:#aaa">Thinking...</span>', 'bot');
        ipcRenderer.invoke('ai-chatbot-query', q).then(answer => {
          aiMessages.lastChild.remove();
          appendMsg(answer, 'bot');
        }).catch(() => {
          aiMessages.lastChild.remove();
          appendMsg('Sorry, I could not get a response.', 'bot');
        });
      });

      // New Chat button logic
      document.getElementById('ai-chatbot-newchat').addEventListener('click', () => {
        aiMessages.innerHTML = '';
        showStarterMsg();
        aiInput.value = '';
        aiInput.focus();
      });

      // Show starter message on open
      aiIcon.addEventListener('click', (e) => {
        if (dragging) return;
        if (aiWindow.style.display === 'none') {
          showStarterMsg();
          // Border animation
          const borderAnim = document.getElementById('ai-chatbot-border-anim');
          if (borderAnim) {
            borderAnim.classList.add('active');
            setTimeout(() => borderAnim.classList.remove('active'), 1200);
          }
        }
      });

      document.getElementById('ai-chatbot-newchat').addEventListener('click', () => {
        aiMessages.innerHTML = '';
        showStarterMsg();
        aiInput.value = '';
        aiInput.focus();
        // Border animation
        const borderAnim = document.getElementById('ai-chatbot-border-anim');
        if (borderAnim) {
          borderAnim.classList.add('active');
          setTimeout(() => borderAnim.classList.remove('active'), 1200);
        }
      });

      // Icon hover animation
      aiIcon.addEventListener('mouseenter', () => {
        aiIcon.classList.add('animated');
        document.getElementById('ai-chatbot-svg').classList.add('animated');
      });
      aiIcon.addEventListener('mouseleave', () => {
        aiIcon.classList.remove('animated');
        document.getElementById('ai-chatbot-svg').classList.remove('animated');
      });



      // Toggle playlist URL input
      const nodeTypeSelect = document.getElementById('node-type');
      const playlistUrlInput = document.getElementById('playlist-url');
      nodeTypeSelect.addEventListener('change', () => {
        playlistUrlInput.style.display = nodeTypeSelect.value === 'playlist' ? 'block' : 'none';
        if (nodeTypeSelect.value !== 'playlist') playlistUrlInput.value = '';
      });

      // Dark mode
      const toggle = document.getElementById('dark-mode-toggle');
      toggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
      });

      // Create node
      const form = document.getElementById('create-node-form');
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        ipcRenderer.send('create-node', {
          name: document.getElementById('node-name').value,
          type: document.getElementById('node-type').value,
          playlistUrl: playlistUrlInput.value.trim()
        });
        form.reset();
      });




      // Render nodes
      ipcRenderer.on('load-nodes', (event, nodes) => {
  const container = document.getElementById('nodes-container');
  container.innerHTML = '';

  nodes.forEach(node => {
  const div = document.createElement('div');
  div.classList.add('node');
  div.setAttribute('data-id', node.id);

    // Node header with (checked/total) counter and progress bar (removed node-complete checkbox)
    const headerHtml = `
      <div class="node-header">
        <span class="node-title">${node.name} [${node.type.charAt(0).toUpperCase() + node.type.slice(1)}]</span>
        <span class="node-progress" data-id="${node.id}">(0/0)</span>
      </div>
      <div class="node-progressbar" style="width:100%;height:10px;background:#e0e7ef;border-radius:6px;overflow:hidden;margin-bottom:6px;">
        <div class="node-progressbar-fill" style="height:100%;width:${node.progress || 0}%;background:linear-gradient(90deg,#4ade80 60%,#38bdf8 100%);transition:width 0.3s;"></div>
      </div>
        <div class="node-controls-row node-controls-row-single">
          <button class="continue-btn" data-id="${node.id}" title="Continue"><span>‚ñ∂</span></button>
          <button class="up-btn" data-id="${node.id}" title="Move Up">  ‚áß </button>
          <button class="down-btn" data-id="${node.id}" title="Move Down">  ‚á© </button>
          <button class="notes-btn" data-id="${node.id}" title="Notes"> üìù </button>
          <button class="delete-btn" data-id="${node.id}" title="Delete"> üóë </button>
          <div class="notes-box draggable-notes" style="display:none;">
            <div class="notes-drag-handle" style="cursor:move;user-select:none;padding:4px 0 2px 0;text-align:center;font-size:13px;color:#000;background:transparent;">‚áï Drag</div>
            <textarea class="node-notes" data-id="${node.id}" placeholder="Add notes...">${node.notes || ''}</textarea>
          </div>
          <button class="toggle-content-btn" data-id="${node.id}" title="Expand/Collapse">‚ñº</button>
        </div>
        <div class="node-content" style="display:none;"></div>
      `;
    div.innerHTML = headerHtml;

    const notesBtn = div.querySelector('.notes-btn');
    const notesPopup = div.querySelector('.notes-box');
    const notesArea = div.querySelector('.node-notes');

    // Notes toggle
    notesBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      if (notesPopup.style.display === 'none') {
        const rect = notesBtn.getBoundingClientRect();
        notesPopup.style.display = 'block';
        notesPopup.style.position = 'absolute';
        notesPopup.style.top = rect.bottom + window.scrollY + 8 + 'px';
        notesPopup.style.left = rect.left + window.scrollX + 'px';
        notesPopup.style.zIndex = 9999;
        notesPopup.style.minWidth = '240px';
        notesPopup.style.boxShadow = '0 8px 32px rgba(60,80,120,0.18)';
        notesPopup.style.borderRadius = '12px';
      } else {
        notesPopup.style.display = 'none';
      }
    });

    // Make notes-box draggable
    const dragHandle = notesPopup.querySelector('.notes-drag-handle');
    let dragOffsetX = 0, dragOffsetY = 0, dragging = false;
    dragHandle.addEventListener('mousedown', function(e) {
      dragging = true;
      const rect = notesPopup.getBoundingClientRect();
      dragOffsetX = e.clientX - rect.left;
      dragOffsetY = e.clientY - rect.top;
      notesPopup.style.transition = 'none';
      document.addEventListener('mousemove', dragMove);
      document.addEventListener('mouseup', dragEnd);
      e.preventDefault();
    });
    function dragMove(e) {
      if (!dragging) return;
      notesPopup.style.left = (e.clientX - dragOffsetX) + 'px';
      notesPopup.style.top = (e.clientY - dragOffsetY) + 'px';
    }
    function dragEnd() {
      dragging = false;
      notesPopup.style.transition = '';
      document.removeEventListener('mousemove', dragMove);
      document.removeEventListener('mouseup', dragEnd);
    }

    // Save notes on blur
    if (notesArea) {
      notesArea.addEventListener('blur', e => {
        ipcRenderer.send('save-notes', { id: node.id, notes: e.target.value });
        notesPopup.style.display = 'none';
      });
    }

    document.addEventListener('click', (event) => {
      if (!notesPopup.contains(event.target) && event.target !== notesBtn) {
        notesPopup.style.display = 'none';
      }
    });

    container.appendChild(div);

    const contentDiv = div.querySelector('.node-content');
    const toggleBtn = div.querySelector('.toggle-content-btn');

    // Toggle dropdown content
    toggleBtn.addEventListener('click', () => {
      if (contentDiv.style.display === 'none') {
        contentDiv.style.display = 'block';
        toggleBtn.textContent = '‚ñ≤';
      } else {
        contentDiv.style.display = 'none';
        toggleBtn.textContent = '‚ñº';
      }
    });

    // Helper: update progress counter
    function updateNodeProgress() {
      const nodeProgress = div.querySelector('.node-progress');
      const progressBarFill = div.querySelector('.node-progressbar-fill');
      const checkboxes = contentDiv.querySelectorAll('.video-watched');
      const checked = contentDiv.querySelectorAll('.video-watched:checked').length;
      nodeProgress.textContent = `(${checked}/${checkboxes.length})`;

      // update progress bar width only
      if (checkboxes.length > 0) {
        const pct = Math.round((checked / checkboxes.length) * 100);
        progressBarFill.style.width = pct + '%';
      } else {
        progressBarFill.style.width = '0%';
      }
    }

    // Custom node content
    if (node.type === 'custom') {
      const customHtml = `
        <div class="custom-area" data-id="${node.id}">
          <div class="add-video-row">
            <input class="add-video-url" type="text" placeholder="Add video URL">
            <input class="add-video-ts" type="text" placeholder="Timestamp mm:ss">
            <button class="add-video-btn" data-id="${node.id}">Add</button>
            <button class="mark-all-btn" data-id="${node.id}">Mark All Watched</button>
          </div>
          <div class="mark-upto-row" style="margin:6px 0;display:flex;gap:6px;align-items:center;">
            <input type="number" class="mark-upto-input" min="1" placeholder="Mark UpTo">
            <button class="mark-upto-btn" data-id="${node.id}">Mark Up To</button>
          </div>
          <ul class="video-list"></ul>
        </div>
      `;
      contentDiv.innerHTML = customHtml;

      const customArea = contentDiv.querySelector('.custom-area');
      const addBtn = customArea.querySelector('.add-video-btn');
      const urlInput = customArea.querySelector('.add-video-url');
      const tsInput = customArea.querySelector('.add-video-ts');
      const markAllBtn = customArea.querySelector('.mark-all-btn');
      const videoList = customArea.querySelector('.video-list');

      addBtn.addEventListener('click', () => {
        const url = urlInput.value.trim();
        const ts = tsInput.value.trim() || '00:00';
        if (!url) return;
        ipcRenderer.send('add-video-to-node', { id: node.id, url, ts });
        urlInput.value = '';
        tsInput.value = '';
      });

      markAllBtn.addEventListener('click', () => {
        ipcRenderer.send('mark-all-videos', { id: node.id, watched: 1 });
      });

      ipcRenderer.invoke('get-videos', node.id).then(videos => {
        videoList.innerHTML = '';
        videos.forEach(v => {
          const li = document.createElement('li');
          li.classList.add('video-item');
          if (v.watched) li.classList.add('greyed-out');
          li.innerHTML = `
            <input type="checkbox" class="video-watched" data-id="${v.id}" ${v.watched ? 'checked' : ''}>
            <span class="video-url">${v.url}</span>
            <span class="video-ts">(${v.timestamp})</span>
            <button class="continue-video-btn" data-url="${v.url}" data-ts="${v.timestamp}">Continue</button>
            <button class="del-video-btn" data-id="${v.id}">Delete</button>
          `;
          videoList.appendChild(li);

          // Greyout logic for custom videos
          const checkbox = li.querySelector('.video-watched');
          checkbox.addEventListener('change', ev => {
            ipcRenderer.send('toggle-video-watched', {
              videoId: ev.target.dataset.id,
              watched: ev.target.checked ? 1 : 0,
              nodeId: node.id
            });
            if (ev.target.checked) {
              li.classList.add('greyed-out');
            } else {
              li.classList.remove('greyed-out');
            }
            updateNodeProgress();
          });

          li.querySelector('.continue-video-btn').addEventListener('click', ev =>
            ipcRenderer.send('continue-video', { url: ev.target.dataset.url, ts: ev.target.dataset.ts })
          );

          li.querySelector('.del-video-btn').addEventListener('click', ev => {
            if (confirm('Delete this video?')) {
              ipcRenderer.send('delete-custom-video', { videoId: ev.target.dataset.id, nodeId: node.id });
            }
          });
        });

        updateNodeProgress(); // init

        // Mark Up To logic for custom group
        const markUptoBtn = customArea.querySelector('.mark-upto-btn');
        const markUptoInput = customArea.querySelector('.mark-upto-input');
        markUptoBtn.addEventListener('click', () => {
          const upto = parseInt(markUptoInput.value);
          if (upto > 0 && upto <= videos.length) {
            // Mark all videos up to the given index as watched
            videos.forEach((v, idx) => {
              const watched = idx < upto ? 1 : 0;
              ipcRenderer.send('toggle-video-watched', {
                videoId: v.id,
                watched,
                nodeId: node.id
              });
            });
            // Update checkboxes and greyout visually
            const boxes = videoList.querySelectorAll('.video-watched');
            boxes.forEach((cb, idx) => {
              cb.checked = idx < upto;
              if (cb.checked) {
                cb.closest('li').classList.add('greyed-out');
              } else {
                cb.closest('li').classList.remove('greyed-out');
              }
            });
            updateNodeProgress();
          }
        });
      }).catch(console.error);
    }

    // Playlist node content
    if (node.type === 'playlist') {
      contentDiv.innerHTML = `
        <div class="playlist-area" data-id="${node.id}">
          <div class="mark-upto-row" style="margin:6px 0;display:flex;gap:6px;align-items:center;">
            <input type="number" class="mark-upto-input" min="1" placeholder="Mark UpTo">
            <button class="mark-upto-btn" data-id="${node.id}">Mark</button>
          </div>
          <ul class="playlist-videos"></ul>
        </div>`;
      const playlistArea = contentDiv.querySelector('.playlist-area');
      const ul = playlistArea.querySelector('.playlist-videos');

      ipcRenderer.invoke('get-playlist-videos', node.id).then(videos => {
        ul.innerHTML = '';
        videos.forEach(v => {
          const li = document.createElement('li');
          li.classList.add('playlist-video');
          if (v.watched) li.classList.add('greyed-out');
          // Use flex to align continue button right
          li.style.display = 'flex';
          li.style.alignItems = 'center';
          li.style.gap = '8px';
          li.innerHTML = `
            <input type="checkbox" class="video-watched" data-id="${v.id}" ${v.watched ? 'checked' : ''}>
            <span style="flex:1;">${v.title}</span>
            <button class="continue-playlist-btn" data-vid="${v.video_id}" style="margin-left:auto;">Play ‚ñ∂</button>
          `;
          ul.appendChild(li);

          // Greyout logic for playlist videos
          const checkbox = li.querySelector('.video-watched');
          checkbox.addEventListener('change', ev => {
            ipcRenderer.send('toggle-playlist-watched', {
              videoId: ev.target.dataset.id,
              nodeId: node.id,
              watched: ev.target.checked ? 1 : 0
            });
            if (ev.target.checked) {
              li.classList.add('greyed-out');
            } else {
              li.classList.remove('greyed-out');
            }
            updateNodeProgress();
          });

          li.querySelector('.continue-playlist-btn').addEventListener('click', ev =>
            ipcRenderer.send('continue-playlist-video', { videoId: ev.target.dataset.vid })
          );
        });

        updateNodeProgress(); // init

        // Mark Up To logic for playlist
        const markUptoBtn = playlistArea.querySelector('.mark-upto-btn');
        const markUptoInput = playlistArea.querySelector('.mark-upto-input');
        markUptoBtn.addEventListener('click', () => {
          const upto = parseInt(markUptoInput.value);
          if (upto > 0 && upto <= videos.length) {
            videos.forEach((v, idx) => {
              const watched = idx < upto ? 1 : 0;
              ipcRenderer.send('toggle-playlist-watched', {
                videoId: v.id,
                nodeId: node.id,
                watched
              });
            });
            // Update checkboxes and greyout visually
            const boxes = ul.querySelectorAll('.video-watched');
            boxes.forEach((cb, idx) => {
              cb.checked = idx < upto;
              if (cb.checked) {
                cb.closest('li').classList.add('greyed-out');
              } else {
                cb.closest('li').classList.remove('greyed-out');
              }
            });
            updateNodeProgress();
          }
        });
      });
    }

    // Node controls
    // Removed node-complete checkbox logic

    div.querySelector('.continue-btn').addEventListener('click', () =>
      ipcRenderer.send('continue-node', { id: node.id })
    );
    div.querySelector('.delete-btn').addEventListener('click', () => {
      if (confirm('Delete this node and all its videos?')) {
        ipcRenderer.send('delete-node', { id: node.id });
      }
    });
    div.querySelector('.up-btn').addEventListener('click', () =>
      ipcRenderer.send('move-node', { id: node.id, direction: 'up' })
    );
    div.querySelector('.down-btn').addEventListener('click', () =>
      ipcRenderer.send('move-node', { id: node.id, direction: 'down' })
    );
    div.querySelector('.node-notes').addEventListener('blur', e =>
      ipcRenderer.send('save-notes', { id: node.id, notes: e.target.value })
    );
  });
});




      ipcRenderer.on('play-video', (event, data) => {
        document.getElementById('video-player').innerHTML = `
          <div class="video-wrapper">
            <button class="close-video">√ó</button>
            <iframe width="640" height="360"
              src="https://www.youtube.com/embed/${data.videoId}?autoplay=1&rel=0"
              frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
          </div>
        `;

        // Close button logic
        document.querySelector('.close-video').addEventListener('click', () => {
          document.getElementById('video-player').innerHTML = '';
        });

      });
      
      // Make video-player draggable
      function makeDraggable(el) {
        let pos = { x: 0, y: 0, offsetX: 0, offsetY: 0 };

        el.querySelector('.video-wrapper').addEventListener('mousedown', (e) => {
          pos.offsetX = e.clientX - el.offsetLeft;
          pos.offsetY = e.clientY - el.offsetTop;

          function onMouseMove(ev) {
            pos.x = ev.clientX - pos.offsetX;
            pos.y = ev.clientY - pos.offsetY;

            // keep inside window bounds
            pos.x = Math.max(0, Math.min(window.innerWidth - el.offsetWidth, pos.x));
            pos.y = Math.max(0, Math.min(window.innerHeight - el.offsetHeight, pos.y));

            el.style.left = pos.x + 'px';
            el.style.top = pos.y + 'px';
            el.style.bottom = 'auto'; // disable bottom/right anchor when dragging
            el.style.right = 'auto';
          }

          function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
          }

          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        });
      }

      ipcRenderer.on('play-video', (event, data) => {
        const vp = document.getElementById('video-player');
        vp.innerHTML = `
          <div class="video-wrapper">
            <div id="drag-handle">‚áï</div>
            <button class="close-video">√ó</button>
            <iframe width="100%" height="100%"
            src="https://www.youtube.com/embed/${data.videoId}?autoplay=1&rel=0"
            frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
          </div>
        `;

        // Reset anchors for fixed positioning
        vp.style.left = 'auto';
        vp.style.top = 'auto';
        vp.style.right = '20px';
        vp.style.bottom = '20px';

        // Close button
        document.querySelector('.close-video').addEventListener('click', () => {
          vp.innerHTML = '';
        });

        // Make draggable
        makeDraggable(vp);
      });


      // Info icon popover logic
      const infoIcon = document.getElementById('info-icon');
      const infoPopover = document.getElementById('info-popover');
      const closeInfoBtn = document.getElementById('close-info-popover');
      infoIcon.addEventListener('click', () => {
        infoPopover.style.display = 'block';
      });
      closeInfoBtn.addEventListener('click', () => {
        infoPopover.style.display = 'none';
      });
      document.addEventListener('click', (e) => {
        if (!infoPopover.contains(e.target) && e.target !== infoIcon && !infoIcon.contains(e.target)) {
          infoPopover.style.display = 'none';
        }
      });
// --- Streak Graph Logic (DB version) ---
function getLast30Days() {
  const days = [];
  const now = new Date();
  for (let i = 29; i >= 0; i--) {
    const d = new Date(now);
    d.setDate(now.getDate() - i);
    days.push(d.toISOString().slice(0, 10));
  }
  return days;
}
function getStreakColor(count) {
  if (count === 0) return 'streak-green-0';
  if (count === 1) return 'streak-green-1';
  if (count === 2) return 'streak-green-2';
  if (count <= 4) return 'streak-green-3';
  if (count <= 7) return 'streak-green-4';
  return 'streak-green-5';
}
async function renderStreakGraph(nodeId = 0) {
  const days = getLast30Days();
  const graph = document.getElementById('streak-graph');
  const label = document.getElementById('streak-graph-label');
  graph.innerHTML = '';
  // Fetch streaks from DB
  const streakRows = await ipcRenderer.invoke('get-streaks', { nodeId, days: 30 });
  const streakMap = {};
  streakRows.forEach(row => { streakMap[row.date] = row.count; });
  days.forEach(day => {
    const count = streakMap[day] || 0;
    const square = document.createElement('div');
    square.className = 'streak-square ' + getStreakColor(count);
    square.title = `${day}: ${count} watched`;
    graph.appendChild(square);
  });
  if (nodeId && window.nodeNameMap && window.nodeNameMap[nodeId]) {
    label.innerHTML = `<span style='color:#22c55e;font-weight:600;'>${window.nodeNameMap[nodeId]}</span> streak (last 30 days)`;
  } else {
    label.textContent = 'Le-Git Streaks';
  }
}

// Build nodeNameMap for quick lookup
window.nodeNameMap = {};
let selectedNodeId = 0;
ipcRenderer.on('load-nodes', (event, nodes) => {
  window.nodeNameMap = {};
  nodes.forEach(node => {
    window.nodeNameMap[node.id] = node.name;
  });
  renderStreakGraph(selectedNodeId);
});

const nodesContainer = document.getElementById('nodes-container');
nodesContainer.addEventListener('click', function(e) {
  let nodeDiv = e.target.closest('.node');
  if (nodeDiv && nodeDiv.dataset && nodeDiv.dataset.id) {
    selectedNodeId = parseInt(nodeDiv.dataset.id);
    renderStreakGraph(selectedNodeId);
  } else {
    selectedNodeId = 0;
    renderStreakGraph();
  }
});
window.addEventListener('click', function(e) {
  if (!e.target.closest('.node')) {
    if (selectedNodeId) {
      selectedNodeId = 0;
      renderStreakGraph();
    }
  }
});
    </script>
  </body>
</html>
